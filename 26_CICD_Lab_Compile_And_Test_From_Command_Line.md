# Compile and Test From Command Line

## Preamble

Before we can start setting up GitHub to automate our build and tests, it is necessary to know how Visual Studio builds our code, and run our tests.

The plan of this exercise is to learn the process by using only *command-line* tools.



## Projects & Files

There is the standard WPF project, and an XUnit project.

Assuming that we are downloading our project from GitHub, with the standardized `.gitignore` file, our download folder will contain the following files:

| File                                 | Description                                                  |
| :----------------------------------- | :----------------------------------------------------------- |
| `CICD_Practice.sln`                  | This is the 'solution' file used by Visual Studio which describes the various necessities to create our projects |
| `CICD_Practice/App.config`           | Information for the compiler and linker, includes version of .NET and whether it is framework vs core. |
| `CICD_Practice/App.xaml`             | Main application configuration                               |
| `CICD_Practice/App.xaml.cs`          | Main application startup code                                |
| `CICD_Practice/CICD_Practice.csproj` | Project File: defines all files that need to be included in the build, as well as all references |
| `CICD_Practice/MainWindow.xaml`      | Main Window design                                           |
| `CICD_Practice/MainWindow.xaml.cs`   | Main Window view                                             |
| `CICD_Practice/dll/*`                | Contains the HomeBudget dll that we are using                |
| `CICD_Practice/Properties/*`         | Configuration files (generated by Visual Studio)             |
| `Test/Test.csproj`                   | Project File: used for testing our code.                     |
| `Test/UnitTest1.cs`                  | Source code for tests                                        |



## Setting up your files

Download project with tests

1) Download the 26_CICD_Practice_Files.zip file from the student notes to an easily located directory (I am going to assume your `Downloads` folder henceforth)
2) Unzip the file.
3) Do ***NOT*** open visual studio!

Using DOS (*actually, it's not dos, it's `command`, but it stems from `DOS`)

Navigate to the directory that contains the solutions file.

* Go to your home directory first... easiest way is by using the environment variable `USERPROFILE`

> DOS NOTES:
>
> `DOS` uses `cd`, just like bash, but the directory separators are backslashes `\` instead of forward slashes `/`.
>
> To autocomplete file names, press tab, if you don't see what you want, hit tab again.
>
> In `bash`, variables are accessed by using the dollar sign `$` in front of the variable name, but `DOS` does it different.  Enclose the variable name in percent signs `%`.  Example: `%variable%`.
>
> To see which environment variables are currently available, type `set` and hit return

```text
C:>cd %userprofile%
C:\Users\SandyLocal>
C:\Users\SandyLocal>cd Downloads\26_PracticeCommandLine\PracticeCommandLine

C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine>dir
 Volume in drive C has no label.
 Volume Serial Number is D018-C8ED

 Directory of C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine

04/10/2022  07:38 PM    <DIR>          .
04/10/2022  07:38 PM    <DIR>          ..
04/10/2022  07:38 PM    <DIR>          CICD_Practice
04/10/2022  07:10 PM             1,611 CICD_Practice.sln
04/10/2022  07:38 PM    <DIR>          Test
               1 File(s)          1,611 bytes
               4 Dir(s)  93,858,283,520 bytes free

C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine>
```



## Finding `msbuild`

To build our solution, we need to use a program called `msbuild`.  We know it is on our computer, because Visual Studio uses this program to build our code.

Go back to your command window, and type `msbuild`

```text
C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine>msbuild
'msbuild' is not recognized as an internal or external command,
operable program or batch file.
```

OK, so that didn't work.  Now what?  We have to find where `msbuild.exe` is.

We know that Visual Studio uses it to build. It must be included with the VS application. A good place to look for msbuild.exe is where VS 2022 is installed. You could check the properties of your VS 2022 application to find the folder where it is installed. This is normally in  `C:\Program Files` for 64 bit applications or `C:\Program Files (86)`.

> DOS NOTES:
>
> The dos  equivalent of `ls` is `dir`, it's short for *directory*
>
> To list a specific file, use `dir `*`filename`*
>
> If you hare looking for files, but you don't know which sub-directory it is in, you can use the switch `/s` (you could read about this switch and others available on the dir command by accessing its help page: >dir /? or >dir -help)
>
> * BUT: you can only search through sub-directories below the one you are currently in (sigh)

> DOS NOTES:
>
> `DOS`, like `bash`, has a command `pushd`*`directory`* which pushes the current directory onto a stack, and then changes to the specified directory.  `popd` will pop off a directory from the stack, and change to that directory

So, for me, VS 2022 Enterprise in in `C:\Program Files`  We are going to save our current directory in a stack by using `pushd`.

```text
C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>pushd "C:\Program Files"

C:\Program Files>dir /s msbuild.exe
 Volume in drive C is Windows
 Volume Serial Number is 1009-54C1

 Directory of C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin

01/16/2023  02:48 PM           318,640 MSBuild.exe
               1 File(s)        318,640 bytes

 Directory of C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\amd64

01/16/2023  02:48 PM           317,568 MSBuild.exe
               1 File(s)        317,568 bytes

     Total Files Listed:
               2 File(s)        636,208 bytes
               0 Dir(s)  633,535,139,840 bytes free

```

Since `amd64` is a specific cpu-type, I am going to choose to use the first one that was found.

## Set the `PATH` to always find `msbuild`.

I am lazy, and do not want to always remember where `msbuild` is located.  So, I am going to set the PATH environment variable.

Again, since I am lazy, and do not need this path to be permanent, I am going to set the path in the `DOS` window, and it will *survive* as long as I have the `cmd` window open.

> DOS NOTES:
>
> To set an environment variable: `set name=value`
>

Remember, when setting the PATH environment variable, you also need to keep what was there before.  Path names are separated by semi-colons `;`.  Because there is a space in the path name, it needs to be enclosed in quotes.

```text
C:\Program Files>set path="C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin";%path%

C:\Program Files>echo %path%
"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin";C:\Program Files\Eclipse Foundation\jdk-8.0.302.8-hotspot\bin;C:\sqlite\sqlite-tools-win32-x86-3370200\sqlite-tools-win32-x86-3370200;C:\windows\system32;C:\windows;C:\windows\System32\Wbem;C:\windows\System32\WindowsPowerShell\v1.0\;C:\windows\System32\OpenSSH\;C:\Program Files\Microsoft VS Code\bin;C:\Program Files\PuTTY\;C:\Program Files\Microsoft SQL Server\130\Tools\Binn\
```



## Build Projects (first attempt)

Go back to the directory where the solution file is

```text
C:\Program Files>popd

C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>
```

Now try `msbuild `*`solution_file`*

```text
C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>msbuild CICD_Practice.sln
MSBuild version 17.4.1+9a89d02ff for .NET Framework
```

OOPS, WE HAVE ERRORS!

<span style="color:darkred">C:\Program Files\dotnet\sdk\7.0.102\Sdks\Microsoft.NET.Sdk\targets\Microsoft.PackageDependencyResolution.targets(267,
5): error NETSDK1004: Assets file 'C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\o
bj\project.assets.json' not found. Run a NuGet package restore to generate this file. [C:\Users\helen.katalifos\Downloa
ds\26_PracticeCommandLine\PracticeCommandLine\Test\Test.csproj]</span>

Reading the error message carefully, it mentions that we are missing a `Nuget` packages.  Our project uses packages, so I guess that's the problem.

## Restore packages

Reading up on package restoring https://learn.microsoft.com/en-us/nuget/consume-packages/package-restore, I see that this can be done using msbuild, nuget command-line, or dotnet.

Use `msbuild` with the `-restore`  flag to download all the required packages. 

```text
C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>msbuild CICD_Practice.sln -restore

```

 The output shown above is not complete.



## Build Projects (second attempt)

```text
C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>msbuild CICD_Practice.sln
Microsoft (R) Build Engine version 16.11.2+f32259642 for .NET Framework
Copyright (C) Microsoft Corporation. All rights reserved.

...

CopyFilesToOutputDirectory:
  Copying file from "C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\obj\Debug\net5.0\Tes
  t.dll" to "C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\bin\Debug\net5.0\Test.dll".
  Test -> C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\bin\Debug\net5.0\Test.dll
  Copying file from "C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\obj\Debug\net5.0\Tes
  t.pdb" to "C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\bin\Debug\net5.0\Test.pdb".
Done Building Project "C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\Test.csproj" (defa
ult targets).

Done Building Project "C:\Users\SandyLocal\Downloads\26_PracticeCommandLine\PracticeCommandLine\CICD_Practice.sln" (def
ault targets).


Build succeeded.
    0 Warning(s)
    0 Error(s)

Time Elapsed 00:00:06.61

```



## Running the Unit Tests

To run the unit tests, we will run the `dotnet` command-line tool. It runs unit tests in their respective frameworks. Try running 

```
C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>dotnet test
```

If the `dotnet` CLI is not in your path, you must find it and add it.  Let's repeat the process that we used to find `msbuild.exe`. Let's repeat the process that we used to add `msbuild.exe`.  From a Microsoft documentation search, it seems that `dotnet` is installed directly in `C:\Program Files\`

```test
C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>dotnet test
'dotnet' is not recognized as an internal or external command,
operable program or batch file.

C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>pushd "C:\Program Files"

C:\Program Files>dir /s dotnet.exe
 Volume in drive C is Windows
 Volume Serial Number is 1009-54C1

 Directory of C:\Program Files\dotnet

12/06/2022  10:47 PM           184,968 dotnet.exe
               1 File(s)        184,968 bytes

 Directory of C:\Program Files\Microsoft Visual Studio\2022\Enterprise\dotnet\runtime

01/16/2023  02:47 PM           136,832 dotnet.exe
               1 File(s)        136,832 bytes

     Total Files Listed:
               2 File(s)        321,800 bytes
               0 Dir(s)  631,778,119,680 bytes free

C:\Program Files>set path="C:\Program Files\dotnet";%path%

```

We could now try to run the tests again.

```test
C:\Program Files>popd

C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine>dotnet test
  Determining projects to restore...
  All projects are up-to-date for restore.
  CICD_Practice -> C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine\CICD_Practice\bin\Debu
  g\net6.0-windows\CICD_Practice.dll
  Test -> C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\bin\Debug\net6.0-windows\T
  est.dll
Test run for C:\Users\helen.katalifos\Downloads\26_PracticeCommandLine\PracticeCommandLine\Test\bin\Debug\net6.0-windows\Test.dll (.NETCoreApp,Version=v6.0)
Microsoft (R) Test Execution Command Line Tool Version 17.4.0 (x64)
Copyright (c) Microsoft Corporation.  All rights reserved.

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:     1, Skipped:     0, Total:     1, Duration: < 1 ms - Test.dll (net6.0)

```
